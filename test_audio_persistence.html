<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Persistence Test - Aristo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px 0;
        }
        
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-left: 3px solid #007bff;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üéµ Audio Persistence Test</h1>
    <p>This page tests the new audio persistence functionality to ensure AI-generated audio is saved to and loaded from Supabase correctly.</p>
    
    <div class="test-section">
        <h3>üîß System Status</h3>
        <div id="systemStatus">Checking system configuration...</div>
    </div>
    
    <div class="test-section">
        <h3>üìä Database Connection Test</h3>
        <button onclick="testDatabaseConnection()">Test Database Connection</button>
        <div id="dbStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üóÇÔ∏è Chapter Audio Check</h3>
        <p>Check if there's existing audio for the current chapter:</p>
        <button onclick="checkChapterAudio()">Check Chapter Audio</button>
        <div id="chapterAudioStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üéôÔ∏è Audio Generation Test</h3>
        <p>Generate a small test audio and save it to database:</p>
        <button onclick="testAudioGeneration()">Generate Test Audio</button>
        <div id="audioGenStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üîÑ Audio Retrieval Test</h3>
        <p>Retrieve and validate saved audio from database:</p>
        <button onclick="testAudioRetrieval()">Test Audio Retrieval</button>
        <div id="audioRetrievalStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>üìã Test Results</h3>
        <div id="testResults"></div>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div class="test-section">
        <h3>üîç Console Logs</h3>
        <div id="consoleLogs" class="log"></div>
    </div>

    <!-- Include required scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="/static/js/database.js"></script>
    
    <script>
        // Test configuration
        const TEST_CONFIG = {
            testChapterId: '1', // Default test chapter
            testVoice: 'alloy',
            testModel: 'tts-1',
            testText: 'This is a short test for audio persistence functionality in the Aristo application.'
        };
        
        let testResults = [];
        
        // Override console.log to capture logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function captureLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('consoleLogs');
            logElement.innerHTML += `<div style="color: ${type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black'}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            captureLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            captureLog(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            captureLog(args.join(' '), 'warn');
        };
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
        });
        
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="info">Checking configuration...</div>';
            
            try {
                // Check if required services are available
                const checks = [];
                
                // Check Supabase
                if (typeof supabase === 'undefined') {
                    checks.push('<div class="error">‚ùå Supabase library not loaded</div>');
                } else {
                    checks.push('<div class="success">‚úÖ Supabase library loaded</div>');
                }
                
                // Check DatabaseService
                if (typeof DatabaseService === 'undefined') {
                    checks.push('<div class="error">‚ùå DatabaseService not available</div>');
                } else {
                    checks.push('<div class="success">‚úÖ DatabaseService available</div>');
                    
                    // Check if it's using real database
                    const isReal = await DatabaseService.isUsingRealDatabase();
                    if (isReal) {
                        checks.push('<div class="success">‚úÖ Using real Supabase database</div>');
                    } else {
                        checks.push('<div class="warning">‚ö†Ô∏è Using mock data (Supabase not configured)</div>');
                    }
                }
                
                statusDiv.innerHTML = checks.join('');
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Error checking system: ${error.message}</div>`;
            }
        }
        
        async function testDatabaseConnection() {
            const statusDiv = document.getElementById('dbStatus');
            statusDiv.innerHTML = '<div class="info">Testing database connection...</div>';
            
            try {
                // Test basic database operations
                const books = await DatabaseService.getBooks();
                statusDiv.innerHTML = `<div class="success">‚úÖ Database connection successful. Found ${books.length} books.</div>`;
                
                testResults.push({ test: 'Database Connection', status: 'PASS', details: `Found ${books.length} books` });
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Database connection failed: ${error.message}</div>`;
                testResults.push({ test: 'Database Connection', status: 'FAIL', details: error.message });
            }
        }
        
        async function checkChapterAudio() {
            const statusDiv = document.getElementById('chapterAudioStatus');
            statusDiv.innerHTML = '<div class="info">Checking for existing chapter audio...</div>';
            
            try {
                const existingAudio = await DatabaseService.getChapterAudio(
                    TEST_CONFIG.testChapterId,
                    TEST_CONFIG.testVoice,
                    TEST_CONFIG.testModel
                );
                
                if (existingAudio && existingAudio.audio_data) {
                    statusDiv.innerHTML = `
                        <div class="success">‚úÖ Found existing audio for chapter ${TEST_CONFIG.testChapterId}</div>
                        <div class="info">Voice: ${existingAudio.audio_voice}, Model: ${existingAudio.audio_model}</div>
                        <div class="info">Generated: ${existingAudio.audio_generated_at}</div>
                        <div class="info">Data length: ${existingAudio.audio_data.length} characters</div>
                    `;
                    testResults.push({ test: 'Chapter Audio Check', status: 'PASS', details: 'Audio found' });
                } else {
                    statusDiv.innerHTML = `<div class="warning">‚ö†Ô∏è No existing audio found for chapter ${TEST_CONFIG.testChapterId} with voice ${TEST_CONFIG.testVoice} and model ${TEST_CONFIG.testModel}</div>`;
                    testResults.push({ test: 'Chapter Audio Check', status: 'PASS', details: 'No audio (expected for first run)' });
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Error checking chapter audio: ${error.message}</div>`;
                testResults.push({ test: 'Chapter Audio Check', status: 'FAIL', details: error.message });
            }
        }
        
        async function testAudioGeneration() {
            const statusDiv = document.getElementById('audioGenStatus');
            statusDiv.innerHTML = '<div class="info">Generating test audio...</div>';
            
            try {
                // Simulate audio generation by creating test base64 data
                const testAudioData = JSON.stringify(['test_base64_audio_segment_1', 'test_base64_audio_segment_2']);
                
                // Save to database
                const saveSuccess = await DatabaseService.saveChapterAudio(
                    TEST_CONFIG.testChapterId,
                    testAudioData,
                    TEST_CONFIG.testVoice,
                    TEST_CONFIG.testModel
                );
                
                if (saveSuccess) {
                    statusDiv.innerHTML = `
                        <div class="success">‚úÖ Test audio generated and saved successfully</div>
                        <div class="info">Chapter: ${TEST_CONFIG.testChapterId}</div>
                        <div class="info">Voice: ${TEST_CONFIG.testVoice}, Model: ${TEST_CONFIG.testModel}</div>
                        <div class="info">Data: ${testAudioData.length} characters</div>
                    `;
                    testResults.push({ test: 'Audio Generation', status: 'PASS', details: 'Audio saved successfully' });
                } else {
                    statusDiv.innerHTML = '<div class="error">‚ùå Failed to save test audio</div>';
                    testResults.push({ test: 'Audio Generation', status: 'FAIL', details: 'Save operation failed' });
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Error generating test audio: ${error.message}</div>`;
                testResults.push({ test: 'Audio Generation', status: 'FAIL', details: error.message });
            }
        }
        
        async function testAudioRetrieval() {
            const statusDiv = document.getElementById('audioRetrievalStatus');
            statusDiv.innerHTML = '<div class="info">Testing audio retrieval...</div>';
            
            try {
                const retrievedAudio = await DatabaseService.getChapterAudio(
                    TEST_CONFIG.testChapterId,
                    TEST_CONFIG.testVoice,
                    TEST_CONFIG.testModel
                );
                
                if (retrievedAudio && retrievedAudio.audio_data) {
                    // Parse audio data
                    let audioSegments;
                    try {
                        audioSegments = typeof retrievedAudio.audio_data === 'string' 
                            ? JSON.parse(retrievedAudio.audio_data)
                            : retrievedAudio.audio_data;
                    } catch (parseError) {
                        throw new Error('Failed to parse audio data: ' + parseError.message);
                    }
                    
                    if (Array.isArray(audioSegments) && audioSegments.length > 0) {
                        statusDiv.innerHTML = `
                            <div class="success">‚úÖ Audio retrieved and validated successfully</div>
                            <div class="info">Segments: ${audioSegments.length}</div>
                            <div class="info">Voice: ${retrievedAudio.audio_voice}</div>
                            <div class="info">Model: ${retrievedAudio.audio_model}</div>
                            <div class="info">Generated: ${retrievedAudio.audio_generated_at}</div>
                        `;
                        testResults.push({ test: 'Audio Retrieval', status: 'PASS', details: `Retrieved ${audioSegments.length} segments` });
                    } else {
                        statusDiv.innerHTML = '<div class="error">‚ùå Audio data format is invalid</div>';
                        testResults.push({ test: 'Audio Retrieval', status: 'FAIL', details: 'Invalid audio data format' });
                    }
                } else {
                    statusDiv.innerHTML = '<div class="error">‚ùå No audio data retrieved</div>';
                    testResults.push({ test: 'Audio Retrieval', status: 'FAIL', details: 'No audio data found' });
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Error retrieving audio: ${error.message}</div>`;
                testResults.push({ test: 'Audio Retrieval', status: 'FAIL', details: error.message });
            }
        }
        
        async function runAllTests() {
            testResults = []; // Clear previous results
            
            console.log('üß™ Starting comprehensive audio persistence tests...');
            
            await testDatabaseConnection();
            await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
            
            await checkChapterAudio();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAudioGeneration();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAudioRetrieval();
            
            // Display summary
            displayTestSummary();
        }
        
        function displayTestSummary() {
            const resultsDiv = document.getElementById('testResults');
            const passed = testResults.filter(t => t.status === 'PASS').length;
            const failed = testResults.filter(t => t.status === 'FAIL').length;
            
            let summary = `<h4>Test Summary: ${passed} passed, ${failed} failed</h4>`;
            
            testResults.forEach(result => {
                const statusClass = result.status === 'PASS' ? 'success' : 'error';
                summary += `
                    <div class="${statusClass}">
                        ${result.status === 'PASS' ? '‚úÖ' : '‚ùå'} ${result.test}: ${result.status}
                        <small>(${result.details})</small>
                    </div>
                `;
            });
            
            if (passed === testResults.length && testResults.length > 0) {
                summary += '<div class="success"><strong>üéâ All tests passed! Audio persistence is working correctly.</strong></div>';
            } else if (failed > 0) {
                summary += '<div class="error"><strong>‚ö†Ô∏è Some tests failed. Check the logs for details.</strong></div>';
            }
            
            resultsDiv.innerHTML = summary;
        }
        
        function clearLogs() {
            document.getElementById('consoleLogs').innerHTML = '';
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
        }
    </script>
</body>
</html>
